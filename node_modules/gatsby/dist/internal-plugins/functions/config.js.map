{"version":3,"sources":["../../../src/internal-plugins/functions/config.ts"],"names":["DEFAULT_LIMIT","defaultBodyParserOptions","limit","defaultUrlEncoded","extended","defaultConfig","bodyParser","text","raw","json","urlencoded","warnings","bodyParserConfigFailover","property","expectedType","actualFailover","_","original","push","replacedWith","functionConfigSchema","Joi","object","keys","type","string","alternatives","number","default","failover","unknown","boolean","required","createConfig","userConfig","functionObj","value","validate","length","warning","reporter","warn","originalRelativeFilePath","JSON","stringify"],"mappings":"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","sourcesContent":["import Joi from \"joi\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport type { IGatsbyFunction } from \"../../internal\"\nimport type {\n  GatsbyFunctionBodyParserCommonMiddlewareConfig,\n  GatsbyFunctionBodyParserUrlencodedConfig,\n} from \"gatsby\"\n\nconst DEFAULT_LIMIT = `100kb`\n\n// similar to `GatsbyFunctionBodyParserConfig` and `IGatsbyFunctionConfigProcessed`\n// from index.d.ts, just with fields required (not optional).\n// `createConfig()` will fill in defaults\nexport interface IGatsbyBodyParserConfigProcessed {\n  json: GatsbyFunctionBodyParserCommonMiddlewareConfig\n  raw: GatsbyFunctionBodyParserCommonMiddlewareConfig\n  text: GatsbyFunctionBodyParserCommonMiddlewareConfig\n  urlencoded: GatsbyFunctionBodyParserUrlencodedConfig\n}\nexport interface IGatsbyFunctionConfigProcessed {\n  bodyParser: IGatsbyBodyParserConfigProcessed\n}\n\nconst defaultBodyParserOptions: GatsbyFunctionBodyParserCommonMiddlewareConfig =\n  {\n    limit: DEFAULT_LIMIT,\n  }\nconst defaultUrlEncoded = { extended: true }\nconst defaultConfig = {\n  bodyParser: {\n    text: defaultBodyParserOptions,\n    raw: defaultBodyParserOptions,\n    json: defaultBodyParserOptions,\n    urlencoded: { ...defaultBodyParserOptions, ...defaultUrlEncoded },\n  },\n}\n\nlet warnings: Array<{\n  property: string | null\n  original: any\n  expectedType: string\n  replacedWith: any\n}> = []\n\nfunction bodyParserConfigFailover(\n  property: keyof IGatsbyBodyParserConfigProcessed,\n  expectedType: string\n): any {\n  return function actualFailover(_, { original }): any {\n    warnings.push({\n      property: `bodyParser.${property}`,\n      original,\n      expectedType,\n      replacedWith: defaultConfig.bodyParser[property],\n    })\n\n    return defaultConfig.bodyParser[property]\n  }\n}\n\nconst functionConfigSchema: Joi.ObjectSchema<IGatsbyFunctionConfigProcessed> =\n  Joi.object()\n    .keys({\n      bodyParser: Joi.object()\n        .keys({\n          json: Joi.object()\n            .keys({\n              type: Joi.string(),\n              limit: Joi.alternatives(Joi.string(), Joi.number()),\n            })\n            .default(defaultConfig.bodyParser.json)\n            .failover(\n              bodyParserConfigFailover(\n                `json`,\n                `{\\n  type?: string\\n  limit?: string | number\\n}`\n              )\n            )\n            .unknown(false),\n          text: Joi.object()\n            .keys({\n              type: Joi.string(),\n              limit: Joi.alternatives(Joi.string(), Joi.number()),\n            })\n            .unknown(false)\n            .default(defaultConfig.bodyParser.text)\n            .failover(\n              bodyParserConfigFailover(\n                `text`,\n                `{\\n  type?: string\\n  limit?: string | number\\n}`\n              )\n            ),\n          raw: Joi.object()\n            .keys({\n              type: Joi.string(),\n              limit: Joi.alternatives(Joi.string(), Joi.number()),\n            })\n            .unknown(false)\n            .default(defaultConfig.bodyParser.raw)\n            .failover(\n              bodyParserConfigFailover(\n                `raw`,\n                `{\\n  type?: string\\n  limit?: string | number\\n}`\n              )\n            ),\n          urlencoded: Joi.object()\n            .keys({\n              type: Joi.string(),\n              limit: Joi.alternatives(Joi.string(), Joi.number()),\n              extended: Joi.boolean().required(),\n            })\n            .unknown(false)\n            .default(defaultConfig.bodyParser.urlencoded)\n            .failover(\n              bodyParserConfigFailover(\n                `urlencoded`,\n                `{\\n  type?: string\\n  limit: string | number\\n  extended: boolean\\n}`\n              )\n            ),\n        })\n        .unknown(false)\n        .default(defaultConfig.bodyParser)\n        .failover((_, { original }) => {\n          warnings.push({\n            property: `bodyParser`,\n            original,\n            expectedType: `{\\n  text?: GatsbyFunctionBodyParserCommonMiddlewareConfig\\n  json?: GatsbyFunctionBodyParserCommonMiddlewareConfig\\n  raw?: GatsbyFunctionBodyParserCommonMiddlewareConfig\\n  urlencoded?: GatsbyFunctionBodyParserUrlencodedConfig\\n}`,\n            replacedWith: defaultConfig.bodyParser,\n          })\n          return defaultConfig.bodyParser\n        }),\n    })\n    .unknown(false)\n    .default(defaultConfig)\n    .failover((_, { original }) => {\n      warnings.push({\n        property: null,\n        original,\n        expectedType: `{\\n  bodyParser?: GatsbyFunctionBodyParserConfig\\n}`,\n        replacedWith: defaultConfig,\n      })\n      return defaultConfig\n    })\n\nexport function createConfig(\n  userConfig: unknown,\n  functionObj: IGatsbyFunction\n): IGatsbyFunctionConfigProcessed {\n  warnings = []\n  const { value } = functionConfigSchema.validate(userConfig)\n\n  if (warnings.length) {\n    for (const warning of warnings) {\n      reporter.warn(\n        `${\n          warning.property\n            ? `\\`${warning.property}\\` property of exported config`\n            : `Exported config`\n        } in \\`${\n          functionObj.originalRelativeFilePath\n        }\\` is misconfigured.\\nExpected object:\\n\\n${\n          warning.expectedType\n        }\\n\\nGot:\\n\\n${JSON.stringify(\n          warning.original\n        )}\\n\\nUsing default:\\n\\n${JSON.stringify(\n          warning.replacedWith,\n          null,\n          2\n        )}`\n      )\n    }\n  }\n\n  return value\n}\n"],"file":"config.js"}